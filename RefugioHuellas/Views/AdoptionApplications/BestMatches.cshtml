@model IEnumerable<RefugioHuellas.Models.ViewModels.BestMatchVm>
@{
    ViewData["Title"] = "Mejores candidatos por compatibilidad";
    var window = (int)(ViewBag.WindowDays ?? 7);
}

<h2>@ViewData["Title"]</h2>

<!-- Formulario oculto: conserva la funcionalidad pero no se muestra -->
<form class="d-none" method="get">
    <div class="row g-2 mb-3">
        <div class="col-auto">
            <label class="col-form-label">Ventana (días)</label>
        </div>
        <div class="col-auto">
            <input type="number" min="1" max="60" name="days" value="@window" class="form-control" />
        </div>
        <div class="col-auto">
            <button class="btn btn-primary">Aplicar</button>
        </div>
    </div>
</form>

<table class="table table-bordered align-middle">
    <thead class="table-light">
        <tr>
            <th>Perro</th>
            <th>Usuario con mayor compatibilidad</th>
            <th>Compatibilidad</th>
            <th>Estado</th>
            <th>Fecha de ingreso</th>
            <th>Fecha de solicitud</th>
            <th>Ventana</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            var end = item.IntakeDate.AddDays(window);
            bool closed = DateTime.UtcNow >= end;
            var color = item.CompatibilityScore >= 75 ? "bg-success text-white"
            : item.CompatibilityScore >= 50 ? "bg-warning text-dark"
            : "bg-danger text-white";

            <tr>
                <td>@item.DogName</td>
                <td>@(item.UserEmail ?? "-")</td>
                <td><span class="badge @color">@item.CompatibilityScore %</span></td>
                <td>@item.Status</td>
                <td>@item.IntakeDate.ToLocalTime().ToString("g")</td>
                <td>@(item.UserEmail == null ? "-" : item.CreatedAt.ToLocalTime().ToString("g"))</td>
                <td>
                    @if (closed)
                    {
                        <span class="badge bg-primary">CERRADA</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary">PROVISIONAL (cierra @end.ToLocalTime().ToString("g"))</span>
                    }
                </td>
                <td class="text-end">
                    @if (item.ApplicationId.HasValue)
                    {
                        <a class="btn btn-outline-primary btn-sm me-2"
                           asp-controller="AdoptionApplications"
                           asp-action="AdminDetails"
                           asp-route-id="@item.ApplicationId.Value">
                            Ver solicitud
                        </a>

                        @if (closed)
                        {
                            <form asp-controller="AdoptionApplications"
                                  asp-action="ApproveFromTop"
                                  method="post"
                                  class="d-inline">
                                <input type="hidden" name="applicationId" value="@item.ApplicationId.Value" />
                                <button class="btn btn-success btn-sm">Aprobar</button>
                            </form>
                        }
                        else
                        {
                            <button class="btn btn-outline-secondary btn-sm" disabled>Esperando cierre</button>
                        }
                    }
                    else
                    {
                        <span class="text-muted">Sin candidatos</span>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>
